<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>4ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: monospace; margin: 20px; max-width: 1200px; }
        .result { padding: 8px; margin: 3px 0; border-radius: 3px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #e2e3e5; color: #383d41; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        .json-display { background: #f8f9fa; padding: 15px; border-left: 3px solid #007cba; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; margin: 10px 0; }
        .object-demo { background: #f0f8ff; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª 4ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ ãƒ†ã‚¹ãƒˆ</h1>
    <p>CLAUDE.mdã«è¨˜è¼‰ã•ã‚ŒãŸã€Œ4ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãã®ãªã‹ã®å…¬é–‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é–¢æ•°ã€ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
    
    <div class="object-demo">
        <h3>ğŸ“‹ 4ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹:</h3>
        <ul>
            <li><strong>cRoute (RouteWrapper)</strong> - çµŒè·¯æ§‹ç¯‰ã‚¯ãƒ©ã‚¹</li>
            <li><strong>cRouteList (RouteListWrapper)</strong> - çµŒè·¯ãƒªã‚¹ãƒˆã‚¯ãƒ©ã‚¹</li>
            <li><strong>cCalcRoute (CalcRouteWrapper)</strong> - é‹è³ƒè¨ˆç®—ã‚¯ãƒ©ã‚¹</li>
            <li><strong>FareInfo (FareInfoData)</strong> - é‹è³ƒè©³ç´°æƒ…å ±ã‚¯ãƒ©ã‚¹</li>
        </ul>
    </div>
    
    <button onclick="testObjectClasses()">ğŸš€ 4ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testObjectWorkflow()">ğŸ”„ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé€£æºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</button>
    <button onclick="testFareInfoProperties()">ğŸ’° FareInfo ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="clearResults()">ğŸ§¹ çµæœã‚¯ãƒªã‚¢</button>
    
    <div id="status" style="padding: 10px; margin: 10px 0; border-radius: 5px; background: #e2e3e5;">
        WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ä¸­...
    </div>
    
    <div id="results"></div>

    <script>
        let FarertModule = null;
        let moduleReady = false;
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, status = 'info') {
            const div = document.createElement('div');
            div.className = 'result ' + status;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¡¨ç¤ºé–¢æ•°
        function displayObject(title, obj) {
            const titleDiv = document.createElement('div');
            titleDiv.className = 'result pass';
            titleDiv.textContent = `${new Date().toLocaleTimeString()} - ${title}`;
            document.getElementById('results').appendChild(titleDiv);
            
            const objDiv = document.createElement('div');
            objDiv.className = 'json-display';
            
            if (typeof obj === 'object' && obj !== null) {
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤º
                let output = '';
                for (const key in obj) {
                    if (typeof obj[key] === 'function') {
                        output += `${key}: [Function]\\n`;
                    } else {
                        output += `${key}: ${obj[key]}\\n`;
                    }
                }
                objDiv.textContent = output || 'Empty object';
            } else {
                objDiv.textContent = String(obj);
            }
            
            document.getElementById('results').appendChild(objDiv);
        }
        
        // WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
        async function loadModule() {
            try {
                document.getElementById('status').textContent = 'WebAssemblyãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                document.getElementById('status').style.background = '#fff3cd';
                
                const module = await import('./dist/farert.js');
                FarertModule = await module.default();
                moduleReady = true;
                
                document.getElementById('status').textContent = 'âœ… 4ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹æº–å‚™å®Œäº†ï¼';
                document.getElementById('status').style.background = '#d4edda';
                
            } catch (error) {
                document.getElementById('status').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                document.getElementById('status').style.background = '#f8d7da';
            }
        }
        
        // 4ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ãƒ†ã‚¹ãƒˆ
        async function testObjectClasses() {
            if (!moduleReady) return;
            
            log('ğŸ§ª 4ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
                FarertModule.openDatabase();
                
                // 1. cRoute (RouteWrapper) ãƒ†ã‚¹ãƒˆ
                log('=== 1. cRoute (RouteWrapper) ãƒ†ã‚¹ãƒˆ ===', 'info');
                const cRoute = new FarertModule.cRoute();
                log('new FarertModule.cRoute(): ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ', 'pass');
                
                // é§…è¿½åŠ 
                const tokyoId = FarertModule.getStationId('æ±äº¬');
                const osakaId = FarertModule.getStationId('å¤§é˜ª');
                
                cRoute.addRoute(tokyoId);
                cRoute.addRoute(osakaId);
                log(`cRoute.addRoute(${tokyoId}), addRoute(${osakaId}): é§…è¿½åŠ å®Œäº†`, 'pass');
                
                const routeCount = cRoute.getRouteCount();
                const startId = cRoute.startStationId();
                const lastId = cRoute.lastStationId();
                log(`cRoute.getRouteCount(): ${routeCount}`, 'pass');
                log(`cRoute.startStationId(): ${startId}, lastStationId(): ${lastId}`, 'pass');
                
                // 2. cRouteList (RouteListWrapper) ãƒ†ã‚¹ãƒˆ
                log('=== 2. cRouteList (RouteListWrapper) ãƒ†ã‚¹ãƒˆ ===', 'info');
                const cRouteList = new FarertModule.cRouteList(cRoute);
                log('new FarertModule.cRouteList(cRoute): ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ', 'pass');
                
                const listStartId = cRouteList.startStationId();
                const listLastId = cRouteList.lastStationId();
                log(`cRouteList.startStationId(): ${listStartId}, lastStationId(): ${listLastId}`, 'pass');
                
                // 3. cCalcRoute (CalcRouteWrapper) ãƒ†ã‚¹ãƒˆ
                log('=== 3. cCalcRoute (CalcRouteWrapper) ãƒ†ã‚¹ãƒˆ ===', 'info');
                const cCalcRoute = new FarertModule.cCalcRoute(cRoute);
                log('new FarertModule.cCalcRoute(cRoute): ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ', 'pass');
                
                const calcRouteCount = cCalcRoute.getRouteCount();
                log(`cCalcRoute.getRouteCount(): ${calcRouteCount}`, 'pass');
                
                // é‹è³ƒè¨ˆç®—å®Ÿè¡Œ
                const fareInfo = cCalcRoute.calcFare();
                log('cCalcRoute.calcFare(): FareInfo ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—æˆåŠŸ', 'pass');
                
                // 4. FareInfo ãƒ†ã‚¹ãƒˆ
                log('=== 4. FareInfo (FareInfoData) ãƒ†ã‚¹ãƒˆ ===', 'info');
                log(`fareInfo.result: ${fareInfo.result}`, 'pass');
                log(`fareInfo.fare: ${fareInfo.fare}`, 'pass');
                log(`fareInfo.isRule114Applied: ${fareInfo.isRule114Applied}`, 'pass');
                log(`fareInfo.availCountForFareOfStockDiscount: ${fareInfo.availCountForFareOfStockDiscount}`, 'pass');
                
                displayObject('ğŸ’° FareInfo ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…å®¹', fareInfo);
                
                log('âœ… 4ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ ãƒ†ã‚¹ãƒˆå®Œäº†', 'pass');
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'fail');
                console.error(error);
            }
        }
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé€£æºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
        async function testObjectWorkflow() {
            if (!moduleReady) return;
            
            log('ğŸ”„ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé€£æºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                FarertModule.openDatabase();
                
                // CLAUDE.mdã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹ã‚’å®Ÿè£…
                // rt = cRoute()
                const rt = new FarertModule.cRoute();
                log('rt = new cRoute(): ä½œæˆå®Œäº†', 'pass');
                
                // rt.setupRoute()
                const setupResult = rt.setupRoute('æ±äº¬,æ–°å®¿,å¤§é˜ª');
                log(`rt.setupRoute('æ±äº¬,æ–°å®¿,å¤§é˜ª'): ${setupResult ? 'æˆåŠŸ' : 'å¤±æ•—'}`, setupResult ? 'pass' : 'fail');
                
                // routeFolder (cRouteList)
                const rtl = new FarertModule.cRouteList(rt);
                log('rtl = new cRouteList(rt): ä½œæˆå®Œäº†', 'pass');
                
                // cCalcRoute(routeList)
                const cds = new FarertModule.cCalcRoute(rtl);
                log('cds = new cCalcRoute(rtl): ä½œæˆå®Œäº†', 'pass');
                
                // let fareInfo : FareInfo = cds.calcFare()
                const fareInfo = cds.calcFare();
                log('fareInfo = cds.calcFare(): é‹è³ƒè¨ˆç®—å®Œäº†', 'pass');
                
                // CLAUDE.mdã®ä¾‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
                log(`fareInfo.fare: ${fareInfo.fare}`, 'pass');
                log(`fareInfo.isRule114Applied: ${fareInfo.isRule114Applied}`, 'pass');
                log(`fareInfo.availCountForFareOfStockDiscount: ${fareInfo.availCountForFareOfStockDiscount}`, 'pass');
                
                log('âœ… ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé€£æºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†', 'pass');
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'fail');
                console.error(error);
            }
        }
        
        // FareInfo ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
        async function testFareInfoProperties() {
            if (!moduleReady) return;
            
            log('ğŸ’° FareInfo ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                FarertModule.openDatabase();
                
                const cRoute = new FarertModule.cRoute();
                cRoute.addRoute(FarertModule.getStationId('æ±äº¬'));
                cRoute.addRoute(FarertModule.getStationId('å¤§é˜ª'));
                
                const cCalcRoute = new FarertModule.cCalcRoute(cRoute);
                const fareInfo = cCalcRoute.calcFare();
                
                // FareInfo ã®å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒ†ã‚¹ãƒˆ
                const properties = [
                    'result', 'fare', 'beginStationId', 'endStationId',
                    'isResultCompanyBeginEnd', 'isResultCompanyMultipassed',
                    'totalSalesKm', 'jrCalcKm', 'jrSalesKm', 'companySalesKm',
                    'fareForCompanyline', 'fareForIC', 'fareForBRT',
                    'childFare', 'academicFare', 'ticketAvailDays',
                    'isRule114Applied', 'availCountForFareOfStockDiscount',
                    'isRoundtrip', 'isRoundtripDiscount',
                    'routeList', 'routeListForTOICA'
                ];
                
                log('FareInfo å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç¢ºèª:', 'info');
                properties.forEach(prop => {
                    if (fareInfo.hasOwnProperty(prop)) {
                        log(`  ${prop}: ${fareInfo[prop]}`, 'pass');
                    } else {
                        log(`  ${prop}: (undefined)`, 'fail');
                    }
                });
                
                // FareInfo ãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ
                log('FareInfo ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª:', 'info');
                const stockDiscount0 = fareInfo.fareForStockDiscount(0);
                const stockDiscountTitle0 = fareInfo.fareForStockDiscountTitle(0);
                log(`fareForStockDiscount(0): ${stockDiscount0}`, 'pass');
                log(`fareForStockDiscountTitle(0): "${stockDiscountTitle0}"`, 'pass');
                
                log('âœ… FareInfo ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ†ã‚¹ãƒˆå®Œäº†', 'pass');
                
            } catch (error) {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'fail');
                console.error(error);
            }
        }
        
        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', loadModule);
    </script>
</body>
</html>